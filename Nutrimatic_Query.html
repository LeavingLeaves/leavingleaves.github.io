<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Nutrimatic Query生成</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            word-wrap: break-word;
        }

        #result {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div style="display: flex; flex-grow:0; flex-shrink: 0;">
        <div style="min-width: 300px; max-width: 300px;">
            <h3><a href="https://nutrimatic.org/" target="_blank">打开Nutrimatic</a></h3>

            <div>匹配串：　<input type="text" onkeydown="genEnter(event)" id="pattern" placeholder="例如L..F，l__f，L??f"></div>
            <div>结果长度：<input type="text" onkeydown="genEnter(event)" id="length" placeholder="例如4，2~4，4 2"></div>
            <div>子串：　　<input type="text" onkeydown="genEnter(event)" id="substr" placeholder="使用空格或逗号隔开"></div>
            <div>连续子串：<input type="text" onkeydown="genEnter(event)" id="lsubstr" placeholder="使用空格或逗号隔开"></div>
            <div>母串：　　<input type="text" onkeydown="genEnter(event)" id="superstr" placeholder="使用空格或逗号隔开"></div>
            <div>不含字母：<input type="text" onkeydown="genEnter(event)" id="nletter" placeholder=""></div>
            <div>后缀开头：<input type="text" onkeydown="genEnter(event)" id="suffix" placeholder="使用空格或逗号隔开"></div>
            <div>前缀结尾：<input type="text" onkeydown="genEnter(event)" id="prefix" placeholder="使用空格或逗号隔开"></div>
            <div>改<input type="text" onkeydown="genEnter(event)" id="changea" value="1" style="width:2ch">
                字母：<input type="text" onkeydown="genEnter(event)" id="changen" placeholder="使用空格或逗号隔开"></div>
            <div>含双字母：<input type="checkbox" id="double"></div>

            <br><button onclick="generate()">生成</button>

            <div id="result"></div>
            <br>
            <a id="redirect" href="https://nutrimatic.org/?q=" target="_blank">https://nutrimatic.org/?q=</a>
        </div>
        <iframe id="nutrimatic" src="https://nutrimatic.org/" style="width: 100%; height: 90vh; border: none;"></iframe>
        <!-- <iframe id="util.in" src="https://util.in/solver" style="width: 100%; height: 90vh; border: none;"></iframe> -->
    </div>
    <script>
        function genEnter(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                generate();
            }
        }
        function generate() {
            let l = [];
            if (document.getElementById("pattern").value.length !== 0) {
                let str = document.getElementById("pattern").value;
                str = str.toLowerCase();
                str = str.replaceAll(/[ _.?]/g, "A");
                l.push(str);
            }
            if (document.getElementById("length").value.length !== 0) {
                let str = document.getElementById("length").value;
                str = str.replaceAll(/[^0-9 ~,-]|(?<!\d)0/g, "");
                str = str.replaceAll(/[~-]/g, ",");
                str = str.split(/\s+/).map(s => {
                    if (!s.includes(",")) { return "A{" + s + "}"; }
                    let minl = Infinity, maxl = 0;
                    if (s[0] === ",") { minl = 0; }
                    if (s[s.length - 1] === ",") { maxl = Infinity; }
                    s = s.split(",").map(e => parseInt(e)).filter(n => !isNaN(n));
                    minl = s.reduce((a, b) => Math.min(a, b), minl);
                    maxl = s.reduce((a, b) => Math.max(a, b), maxl);
                    return "A{" + minl + "," + (maxl === Infinity ? "" : maxl) + "}"
                }).join(' ');
                l.push('"' + str + '"');
            }
            if (document.getElementById("substr").value.length !== 0) {
                let str = document.getElementById("substr").value;
                str.split(/[ ,，]/).forEach(s => {
                    s = s.toLowerCase();
                    s = s.replaceAll(/|/g, "A*");
                    l.push(s);
                });
            }
            if (document.getElementById("lsubstr").value.length !== 0) {
                let str = document.getElementById("lsubstr").value;
                str.split(/[ ,，]/).forEach(s => {
                    s = s.toLowerCase();
                    s = "A*" + s + "A*";
                    l.push(s);
                });
            }
            if (document.getElementById("superstr").value.length !== 0) {
                let str = document.getElementById("superstr").value;
                str.split(/[ ,，]/).forEach(s => {
                    s = s.toLowerCase();
                    s = s.replaceAll(/(?<!^)/g, "?");
                    l.push(s);
                });
            }
            if (document.getElementById("nletter").value.length !== 0) {
                let str = document.getElementById("nletter").value;
                str = str.toLowerCase();
                str = str.replaceAll(/[^a-z]/g, "");
                l.push("[^" + str + "]*");
            }
            if (document.getElementById("suffix").value.length !== 0) {
                let str = document.getElementById("suffix").value;
                str.split(/[ ,，]/).forEach(s => {
                    s = s.toLowerCase();
                    let f = s => s.length === 1 ? s : "(" + f(s.slice(0, s.length - 1)) + ")?" + s[s.length - 1];
                    l.push(f(s) + "A*");
                });
            }
            if (document.getElementById("prefix").value.length !== 0) {
                let str = document.getElementById("prefix").value;
                str.split(/[ ,，]/).forEach(s => {
                    s = s.toLowerCase();
                    let f = s => s.length === 1 ? s : s[0] + "(" + f(s.slice(1)) + ")?";
                    l.push("A*" + f(s));
                });
            }
            if (document.getElementById("changen").value.length !== 0) {
                let str = document.getElementById("changen").value;
                let a = parseInt(document.getElementById("changea").value);
                if (isNaN(a)) a = 0;
                str.split(/[ ,，]/).forEach(s => {
                    s = s.toLowerCase();
                    let res = [];
                    let f = function (s, l, x = -1) {
                        if (l === 0) {
                            res.push(s);
                            return;
                        }
                        for (let i = x + 1; i < s.length; i++) {
                            f(s.slice(0, i) + "A" + s.slice(i + 1), l - 1, i);
                        }
                    }
                    f(s, (a % s.length + s.length) % s.length);
                    l.push("(" + res.join("|") + ")");
                });
            }
            if (document.getElementById("double").checked) {
                l.push("A*(aa|bb|cc|dd|ee|ff|gg|hh|ii|jj|kk|ll|mm|nn|oo|pp|qq|rr|ss|tt|uu|vv|ww|xx|yy|zz)A*");
            }

            let result = l.join("&");

            document.getElementById("result").innerText = result;
            let redirect = "https://nutrimatic.org/?q=" + encodeURIComponent(result);
            let redirect2 = "https://util.in/solver?q=" + encodeURIComponent(result.replaceAll("A", "."));
            let link = document.getElementById("redirect");
            link.innerText = redirect;
            link.href = redirect;
            document.getElementById("nutrimatic").src = redirect;
            // document.getElementById("util.in").src = redirect2;
        }
    </script>
</body>